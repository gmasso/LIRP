\documentclass[a4paper,10pt]{article}
\include{config}

\title{Location Inventory Routing Problem}
	
\author{Guillaume Massonnet$^{1,2}$, Olivier P\'eton$^{1,2}$}
	
\date{$^1$ IMT Atlantique\\ 
	$^2$ LS2N UMR CNRS 6004 (Laboratoire des Sciences du Numérique de Nantes), \\ 4 rue Alfred Kastler, F-44307 Nantes Cedex, France}
	%\cortext[cor]{Corresponding author. name address}
	
\begin{document}
	
\maketitle


\begin{abstract}
	blablabla
	
\textbf{Keywords:}		location, inventory management, routing, sampling heuristics, supply chain
	
\end{abstract}

\modulolinenumbers[5]
\linenumbers
\begin{linenumbers}


\section{Introduction}

For any business, the stock is a major financial asset. 
Therefore, its volume must be controlled in order to avoid stock-out and minimize holding costs. 
The Vendor managed inventory (VMI) is based on the principle that the company selling a product has only a stock directly dedicated to the delivery to customers. In other words, all items received are placed on the shelf and stock replenishment is the responsibility of the supplier. VMI had motivated much research about the joint optimization of the inventory and transport, leading to the inventory routing problem (IRP). The IRP considers one supplier running a fleet of vehicles and a set of customers who consume a good on a multi-period time horizon. The objective of the IRP is to jointly optimize the delivery schedule of customers, the quantities delivered, and the delivery routes to be covered in each period, while minimizing the sum of routing costs and storage costs.

Traditional applications of the IRP have been listed in the survey \cite{Coelho2014}. They mainly concern the distribution of commodities, raw materials or fast moving consumer goods. These activities rely on a stable supply chain network. 
In industrial applications the set of customers is quite stable and the starting points of all defined for a long duration.
For example, distribution of fuel always starts from the same fuel depots, which capacity and location cannot be easily modified. 

In this paper we consider an extension of the IRP concerning emerging activities which supply chain is not yet designed, 
or any activity has to frequently revise its supply chain design, e.g. delivery of e-commerce goods or services to a set of customers that changes over time. We assume a three-level supply chain consisting of one production facility, several intermediate depot called distribution centers (DC) and a larger set of customers. A single product is first carried from the production facility to DCs, and then from DCs to customers. The decision variables concern the location of DCs, the allocation of customers to DC and all IRP decisions previously cited. 
This optimization problem is called the Location Inventory Routing Problem (LIRP). This problem appeared recently in the scientific literature \citep{AhmadiJavid2010} and has been more and more studied since then. 

The contributions of this paper are the following. 
In section \ref{sec:lit}, we review the scientific literature dedicated to the LIRP. 
In section \ref{sec:model}, we propose a new mathematical formulation of the LIRP and show that this formulation is general enough to 
cover several types of supply chain networks. 
In section \ref{sec:algo}, we propose a matheuristic algorithm based on the iterative sampling of the routes. 
In section \ref{sec:expe}, we introduce new LIRP instances and report numerical expriment that show the performance of our algorithm.

\section{Literature Review} \label{sec:lit}



\subsubsection*{Generalites sur les problèmes combines}

The LIRP combines three families of well-known optimization problems: vehicle routing, facility location and inventory management. 
As shown in Figure \ref{fig:circles}, these problems, combined in pairs, already define the location routing problem (LRP), the inventory routing problem (IRP) and the location problem with inventory management (ILP). 

   	\begin{figure}[htbp]
	\centering
	\begin{tikzpicture}[scale=0.18, auto,swap]
	\coordinate (A) at (0,1);
	\coordinate (B) at (12,2);
	\coordinate (C) at (6,14);
	\fill[opacity=0.5,green!40] (C) circle(12);
	\fill[opacity=0.5,red!40] (A)  circle(12);
	\fill[opacity=0.5,blue!40] (B)  circle(12);
	\fill[green,even odd rule] (C) circle(12) circle(12.15);
	\fill[red,even odd rule] (A) circle(12) circle(12.15);
	\fill[blue,even odd rule] (B) circle(12) circle(12.15);
	
	\draw (-10.5,2) node[right] {Facility};
	\draw (-11,0) node[right] {Location};
	\draw (13,2) node[right] {Inventory};
	\draw (11.3,0) node[right] {Management};
	\draw (1,19) node[right] {Vehicle};
	\draw (1,17) node[right] {Routing};
	\draw (4,-4) node[right] {ILP};
	\draw (3,6.5) node[right] {LIRP};
	\draw (-4,10) node[right] {LRP};
	\draw (11,10) node[right] {IRP};
	\end{tikzpicture}
	\caption{Optimization problems combining facility location, inventory management and routing}
	\label{fig:circles}
	\end{figure} 

These three integrated problems have already been the subject of many publications in recent decades.

\begin{itemize}
	
	\item \textbf{IRP: }
	
	The inventory problem has been studied for more than 30 years \citep{Coelho2014}. Prior surveys had been published by \cite{Campbell98}, \cite{MoinSalhi2007}. Interested reader may also read the tutorial by \cite{Bertazzi2012}. 
	
	Very few models consider the inventory routing problem within a two-echelon or multi-echelon network	\citep{GuimaraesCoelho2019}
	
	\item \textbf{LRP: } The Location Routing problem has been introduced 
	
	\cite{Laporte1987} 
	
	Surveys by \cite{MinJS98}, \cite{NagySahli07}, \cite{ProdhonPrins2014}, \cite{DrexlSchneider2015} and \cite{Schneider2017} 
In the context of arc routing, 	\cite{Riquelme2016} inr

	
	\item \textbf{ILP : } As pointed by \cite{Melo2009}, facility location is frequently combined with inventory decisions. However, the integration of inventory and location decisions in a single mathematical model did not give rise to a well-identified optimization problem such as IRP or LRP. 

\end{itemize}

\subsection{Review of the literature}

The location inventory routing problem LIRP has been attracting much research effort in the very recent years, but preliminary works have appeared several decades ago.  
In this section, we review the main publications related to the LIRP.
Section \ref{sec:almost} summarizes the preliminary works that led to a formal definition of the LIRP. 
Next sections described the modeling of the main LIRP components: location and supply chain desgin (section\ref{sec:l}), 
routing (\ref{sec:r} and inventory policies (\ref{sec:i}). 

\subsection{Preliminary works related to the LIRP}
\label{sec:almost}

 The idea of integrating location, inventory and routing decisions in mathematical models is not new, but most models have been considered intractable until the recent progress of mathematical programming solvers and heuristic solution methods. 
In 1988, \cite{PerSir88} pointed the necessary interdependance between location, inventory and routing decisions. 
The authors proposed an integrated model combining location and inventory decisions, but only direct shipments were considered and no computational experiments were presented. 
This model has been extended by \cite{AmbScu05} to a multi-level problem with distribution routes visiting several customers. The authors also propose a dynamic models (with multiple periods). Computational experiments show the practical difficulty of solving static models (with a single time period). 

\cite{DasCShen02} study a joint location-inventory model with risk pooling, facility location, vehicle routing, and inventory control.

Several LIRP related papers considered the three main decisions in a hierarchical way, or priority is given to one or two decisions. 
In \cite{LiuLee03} and \cite{LiuLin05}, inventory mangement decisions are taken independently from routing and location. 
\cite{Shen07} explicitly model facility location and allocation decisions but use approximated routing costs instead of formal routing costs. 
\cite{MetZab10} propose a two-stage stochastic programming approach for a medical supply
storage and distribution problem.
At the first stage, storage locations and the optimal inventory policy are determined. 
At the second stage, a recourse routing plan is optimized for each disaster scenario. 
Routing decision are decoupled from location and inventory decisions. 
Hence, all these references cannot be \textit{stricto sensu} considered as LIRP models. 

\subsection{Supply chain design}
\label{sec:l} 

As an integrated optimization problem, the LIRP usually arises in complex logistics networks with several layers of facilities. 
Depending on the volume of the shipments, transport can be organized in full truckload (FTL) or less than truckload (LTL) legs. 
In FTL transport, shipments are sent directly from their origin to their destination. In LTL transport, routes have one origin and several delivery points. The roads are therefore multi-clients. The presence of a ``routing'' component in the LIRP assumes the existence of routes visiting multiple sites, at least in one part of the supply chain.
The vast majority of LIRP articles deal with three-layer networks such as that illustrated in Figure \ref{fig:directloop}. 
Direct routes are performed between a single production site (large red circle) delivers a set of depots or distribution centers (small red circles). A second echelon includes routes visiting several end customers (blue circles).

\begin{figure}[htbp]
	\centering
	\inputfig{model1}
	\caption{LIRP model with direct+route supply chain design}
		\label{fig:directloop}
	\end{figure}

Several papers deviate from this main scheme.  \cite{Zhang2014} consider only 2 layers: a set of candidate depots and customers. Routes start at a depot and visit several customers ; no inventory decision is made at depots. 

\cite{AmbScu05} and \cite{Tavana2018} extend the main logistics scheme to a 4 layer network. Shipments are direct in the upper echelon whereas LTL routes are performed in the two lower echelons. 
\cite{Eskandari2018} study a blood supply chain with 4 layers. They consider direct shipment between the first three layers and multi-point routes for the final delivery. 
\cite{Bashiri2018} consider a network with multi-point routes at the first echelon and direct deliveries at the second echelon. 
Finally, \cite{Riquelme2016} introduce the location arc routing problem with inventory constraints. 

Moreover, only a few papers (\cite{LiuChenLiLiu2015}, \cite{Deng2016}, \cite{Zhalechian2016} and \cite{LiGuoWangFu2013} 
consider a closed-loop supply chain. 


\subsection{Route formulation}
\label{sec:r}

A large majority of the LIRP mathematical models uses an arc-based representation of the routes. 
However, in many applications, the number of customer visited within a route is limited by a number of practical constraints (time constraints, stopover costs, detour constraints). \cite{MaDav05} propose a distribution chain design  minimizing location fixed costs, inventory costs and transportation costs. They observe that vehicles can only serve one site in their journey, and thus, do not model a full LIRP model. 

\cite{Guerrero2013} propose a route-based model with an exponential number of routes. A relaxation of the model is decomposed into an inventory location problem and a routing problem which is solved by column generation. 
The model in \cite{Lehrlaly2016} is based on all feasible routes with no more than three customers. 
Route based models are also used in \cite{LiGuoWangFu2013}, \cite{LiuChenLiLiu2015},  \cite{Deng2016} and \cite{hiassat_genetic_2017} 
but these papers do not detail routes generation.

\subsection{Inventory policies}
\label{sec:i}

As far as inventory management is concerned, the literature can be classified in two main families: papers considering a continuous review of inventory and those who consider a periodic review. 
In the first case, demand is considered either constant (see e.g. \cite{AhmSed2012}, \cite{Deng2016}) or subject to a known distribution a 
normal distribution (see e.g. \cite{Nekooghadirli2014}, \cite{Zhalechian2016}, \cite{Saragih2018}) or a Poisson distribution (see e.g. \cite{Asadi2018}, \cite{HabibiAS2018}). In these cases, classical continuous review policies such as $(r,Q)$ and $(S-1,S)$ policies are applied \textcolor{red}{Guillaume, il faut qu'on discute de ça} and the same inventory cycle repeats over time. Note that in this category, the objective function often incorporate the average value of inventories or their standard deviation, which yield non linearity. Thus, only small instances can be solved by MINLP solvers, or general purpose heuristics and metaheuristics are used. 


In the latter category, the time horizon is decomposed into several time periods and all demands and flow values within one period are aggregated. This leads to inventory management policies that look like lot-sizing policies. Most references study models in which all data including demand are variable but deterministic (see e.g. \cite{Guerrero2013}, \cite{Zhang2014}, \cite{Ghorbani2016}). 
\cite{Vahdani2018} consider stochastic storage capacity. 
\cite{Rayat2017} explicitly model stochastic demand and propose an MINLP bi-objective model with multiple periods and multiple products. The model is solved with an epsilon constraint and several multi-objective metaheuristics. 
Uncertainty can also be incorporated through various modeling techniques. 
\cite{ChenChenSunLiu2014, TavakkoliIFAC2016} model fuzzy demand ; \cite{Bashiri2018} define demand scenarios ; 



Tables \ref{tab:synthese1} and \ref{tab:synthese2} present a synthesis of the main bibliographic references concerning the LIRP. 
Tables \ref{tab:synthese1} presents models with continuous inventory review. 
Table \ref{tab:synthese2} presents models with time discretization. 

\textcolor{red}{Ajouter texte pour presenter le contenu de chaque colonne}

\begin{table}[htbp]
	\label{tab:synthese1}
	\scriptsize
\begin{tabular}{lccccccc}
	\toprule
	Reference & Periods & Route & Layers   & Flow &  Stochastic & Linear & Inventory \\
             &          & model & 		   & 	   &     demand        &        & policy                 \\
 \midrule
\cite{Yuchi2016}	&	1	&	arc	&	3 &	direct+loop	&	constant	&	NL	&	Wilson	\\	
\cite{AhmadiJavid2010}	&	1	&	arc  &	3 &	direct+loop	&	normal	&	NL	&	(r,Q) 	\\	
\cite{AhmSed2012}	&	1	&	arc &	3 	&	direct+loop	&	constant 	&	NL	&	(0,Q)	\\	
\cite{Nekooghadirli2014}	&	multi	&	arc &	3 	&	direct+loop	&	normal 	&	NL	&	(r,Q) 	\\	
\cite{Seyedhosseini2014} &	1	&	arc	&3 &	direct+loop	&	demand	&	NL	&	(r,Q) 	\\	
\cite{LiuChenLiLiu2015}	&	1	&	route	&	3 	&	direct+loop	&	normal	&	NL	&	(r,Q) 	\\	
\cite{Tang2016}	&	1	&	arc	&	3 	&	direct+loop	&	no	&	NL	&	(Q, R)	\\	
\cite{Zhalechian2016}	&	multi	&	arc	&	3 	&	direct+loop	&	Normal	&	NL	&	(r,Q) 	\\	
\cite{Deng2016} & 1	&	route	&	3 	&	direct+loop	&	no	&	NL	&	(r,Q) 	\\	
\cite{Dehghani2017}	&	1	&	arc	&	3 	&	direct+loop	&	Poisson	&	NL	&	(S-1,S)	\\	
\cite{Rafie-Majd2018}	&multi	&	arc	&	3 	&	direct+loop	&	normal	&	NL	&	(Q,R)	\\	
\cite{HabibiAS2018}		&	1	&	arc	&	3 &	direct+loop	&	 Poisson 	&	NL	&	(S-1,S)	\\	
\cite{Asadi2018}		&	1	&	arc	&	3 	&	direct+loop	&	Poisson 	&	NL	&	(S-1,S)	\\	
\cite{Saragih2018}	&	1	&	arc	&	3 	&	direct+loop	&	 normal	&	NL	&	(r,Q) 	\\	
\cite{Sajjadi2011}	&	1	&	arc  	&	3	&	direct+loop	&	yes	&	NL	&	fixed interval \\	
\cite{ChenChenSunLiu2014}	&	1	&	arc	&	3 	&	direct+loop	&	fuzzy 	&	L	&	Periodic (T,$r_j$)	\\	
\bottomrule
\end{tabular}
\caption{Reference with continuous inventory review}
\end{table}

\begin{table}[htbp]
		\label{tab:synthese2}
		\scriptsize
	\begin{tabular}{lcccccc}
		\toprule
		Reference & Periods & Route & Layers   & Flow &  Stochastic & Linear  \\
					&          & model & 	   & 	   &     demand        &                      \\
		\midrule
\cite{AmbScu05}			&	1 \& multi	&	arc		&	4 	&	direct+loop+loop	&	no	&	L		\\
\cite{Zhang2014}		&	multi		&	arc  	&	2 	&	loop				&	no	&	L	\\
\cite{Guerrero2013}		&	multi		&	route	&	3 	&	direct+loop			&	no	&	L	\\
\cite{TavakkoliIFAC2016}&	multi		&	arc		&	3 	&	direct+loop			&	fuzzy 	&	L	\\
\cite{Ghorbani2016}		&	multi		&	arc		&	3 	&	direct+loop			&	no	&	L\\
\cite{Lehrlaly2016}		&	multi		&	route	&	3 	&	direct+loop			&	no	&	L		\\
\cite{Rayat2017}		&	multi		&	arc		&	3 	&	direct+loop			&	demand (avg, std)	&	NL		\\
\cite{Hiassat2017}		&	multi		&	route	&	3 	&	direct+loop			&	no	&	L		\\
\cite{Riquelme2016}		&	multi		&	arc		&	2 	&	general graph		&	no	&	L	\\
\cite{Tavana2018} 		&	multi		&	arc		&	4 	&	direct+loop+loop 	&	no	&	L		\\
\cite{Vahdani2018}		&	multi		&	arc		&	3 	&	direct+loop			&	storage capacity	&	L	\\
\cite{Eskandari2018}	&	multi		&	arc		&	4 	&	direct+direct+route	&	yes (disaster)	&	L		\\
\cite{Bashiri2018}		&	multi		&	arc		&	3 	&	loop+direct			&	demand (scenarios)	&	L	\\
		\bottomrule
	\end{tabular}
	\caption{Reference with time discretization}
\end{table}




\subsection{Contribution of this paper}

This paper brings contribution in the LIRP literature in three ways. First, we propose new route-based mathematical model that covers both FTL and LTL routes between any layer of the logistics network. Without loss of generality we present this model on a three layer supply chain with one production center, a set of candidate distribution center and a larger set of customers. 
Second, we propose a sampling solution method based on the decomposition of large instances in several smaller instances that are tractable by an MILP solver. 
Finally, we introduce new instaces for the LIRP and present computational experiments that show the relevance of our approach. 


\newpage

\section{The model}

\label{sec:model}

\subsection{Description and notations}
In this work, we present a unified model that covers a broad spectrum of systems in which one supplier (or central plant) produces semi-finished or end products. 
There is a set of candidates depots, that is location onto which {\em distribution centers} (DC), or {\em depots} may be opened to operate as intermediate between the central supplier and a (often larger) set of retailers, also called customers.
The decision to open or not a DC incurs a fixed opening cost for each depot at the beginning of the planning horizon and cannot be changed during the exploitation of the network.
Units stored at a DC or at a customer incur a holding cost that represents the financial immobilisation of the good as well as maintenance costs.
Finally deliveries are made through predefined routes through the network. A route starts either from the supplier and visits a set of depots before returning to the supplier or starts from a depot and visits a set of customers before returning to the same depot. 
Using a route to deliver units during a time period also incurs a transportation cost that consists of a (possibly zero) fixed ordering cost along with a routing cost that depends on the length of the route and its number of stops.

Throughout the paper, the notations of datasets, data and variables are defined in Tables \ref{tab:set}--\ref{tab:var}. 
\begin{table} 
    \centering
    \begin{tabular}{ll}
        \toprule
        $\cu$ & Set of customers \\ 
        $\dc$ & Set of distribution centers j \\
        $\su$ & Set of plants (1 plant here)\\
        $T$ & Length of the planning horizon\\
        $\rd$ & Set of routes starting from the plant and visiting a subset of the depots\\
        $\rc$ & Set of routes starting from a DC and visiting a subset of customers\\
        \bottomrule
    \end{tabular}
 \caption{Datasets}
   \label{tab:set}
\end{table}

\begin{table} 
	\centering
	\begin{tabular}{ll}
		\toprule
         $f_j$ & Fixed cost of opening distribution center $j\in\dc$\\ 
        $\kd$ & Capacity of vehicles delivering distribution centers\\ 
        $\kc$ & Capacity of vehicles delivering customers\\ 
        $\nu_{\dc}$ & fleet size for vehicles delivering distribution centers\\ 
        $\nu_{\cu}$ & fleet size for vehicles delivering customers\\ 
        $d^t_i$ & Demand faced by customer $i\in\cu$ in period $t=1,\ldots,T$\\
        $h^t_i$ & Per-unit, per-period holding cost of location $i\in\cu\cup\dc$ in period $t=1,\ldots, T$\\
        $I_{i0}$ & Initial inventory of location $i\in \cu\cup\dc$ at the beginning of the planning horizon\\
        $c_r$ & Cost of route $r\in \rd\cup\rc$\\
        $\alpha_{ir}$ & indicator of route $r\in\rc$ visits customer $i$\\
        $\beta_{jr}$ & indicator of route $r\in\rc$ visits depot $j$\\
        $\gamma_{jr}$ & indicator of route $r\in\rd$ visits depot $j$\\
        $I_i^{\max}$ & Maximum inventory at location $i\in\dc\cup\cu$\\
         \bottomrule
     \end{tabular}
\caption{Data and parameters}
\label{tab:data}
\end{table}

\begin{table} 
\centering
\begin{tabular}{ll}
	\toprule       
    \multicolumn{2}{l}{\textit{Binary Variables}}\\
    $y_j$ & $=$ 1 if distribution center j is selected \\
    $z^t_r$ & $=$ 1 if route r is selected in period t\\
    \midrule
    \multicolumn{2}{l}{\textit{Continuous variables}}\\
    $u^t_{ir}$ &  quantity delivered by route $r\in\rc$ to customer $i\in\cu$ in period $t=1,\ldots,T$\\
    $v^t_{jr}$ &  quantity delivered by route $r\in\rd$ to location $j\in\dc$ in period $t=1,\ldots,T$\\
    $I^t_i$ &  Inventory at location $i$ in period $t=1,\ldots,T$\\
    \bottomrule
   \end{tabular}
\caption{Variables}
\label{tab:var}
\end{table}

\subsection{MIP formulation}\label{subsection:MIP}
\begin{alignat}{3}
    \text{minimize} &&\sum_{j\in \dc} f_j y_j &+\sum_{t=1}^{T} \left( \sum_{r\in \rd\cup\rc} c_r z^t_r + \sum_{i\in \dc\cup\cu} h^t_i I_i^t\right)\label{objfunct}\\ 
    \text{s.t.}  &&\sum_{r\in \rd} \gamma_{jr} z^t_r &\leq 1 															&\forall j&\in \dc, \forall t=1,\ldots,T  \label{const:singleroutedepots}\\
                 &&\sum_{r\in \rc} \alpha_{ir} z^t_r &\leq 1 															&\forall i&\in \cu, \forall t=1,\ldots,T  \label{const:singleroutecustomers}\\
                 &&\gamma_{jr}z^t_r 					&\leq y_j 													&\forall j&\in\dc, \forall r\in \rd, \forall t=1,\ldots,T\label{const:serveopendepots}\\
                 &&z^t_r 					&\leq \sum_{j\in\dc}\beta_{jr}y_j 													&\forall r&\in \rc, \forall t=1,\ldots,T\label{const:startfromopendepots}\\
                 &&\sum_{r\in \rd} z^t_r &\leq 	\nu_{\dc}													&\forall t&=1,\ldots,T  \label{const:fleetcapadepots}\\
                 &&\sum_{r\in \rc} z^t_r &\leq 	\nu_{\cu}													&\forall t&=1,\ldots,T  \label{const:fleetcapaclients}\\
                 &&\sum_{j\in \dc} v^t_{jr}   		&\leq \kd z^t_r 														&\forall r&\in \rd, t=1,\ldots,T\label{const:deliveryUBdepots}\\
                 &&\sum_{i\in \cu} u^t_{ir}   		&\leq \kc z^t_r 														&\forall r&\in \rc, t=1,\ldots,T\label{const:deliveryUBcustomers}\\
                 &&I^{t-1}_j + \sum_{r\in\rd} v^t_{jr}   			&=I^t_j +\sum_{r\in \rc}\beta_{jr} \left(\sum_{i\in \cu}u^t_{ir}\right) 			&\forall j&\in \dc, \forall t=1,\ldots,T \label{const:invflowdepots}\\
                 &&I^{t-1}_i+\sum_{r\in \rc} u^t_{ir} &= I^t_i +d^t_i 							&\forall i&\in \cu, \forall t=1,\ldots,T\label{const:invflowcustomers}\\
                 &&I^t_j					& \leq I_j^{\max} y_j  														&\forall j&\in \dc,\forall t=1,\ldots,T\label{const:invdepotUB}\\	
                 &&I^t_i 					&\leq \min\left(I_i^{\max}, \sum_{t'\geq t}d^{t'}_i\right)											&\forall i&\in \cu, \forall t=1,\ldots,T\label{const:invcustUB}\\
                 &&u^t_{ir}			&\geq 0 															&\forall i &\in \cu, \forall r\in \rc,\forall t=1,\ldots, T\label{const:upos}	\\
                 &&v^t_{jr}			&\geq 0 															&\forall j &\in \dc, \forall r\in \rd,\forall t=1,\ldots, T\label{const:vpos}	\\
                 &&I^t_{i}			&\geq 0 															&\forall i &\in \cu, \forall t=1,\ldots, T\label{const:invCpos}	\\
                 &&I^t_{j}			&\geq 0 															&\forall j &\in \dc, \forall t=1,\ldots, T\label{const:invDpos}	\\
                 &&y_{j}					& \in \{0,1\} 														&\forall j&\in \dc\label{const:ybool}\\	
                 &&z^t_r					&\in \{0,1\} 														&\forall r&\in \rc\cup\rd, \forall t=1,\ldots,T\label{const:zbool}
\end{alignat}

The objective function~\eqref{objfunct} aims at minimizing the total cost incurred by the system. 
Constraints~\eqref{const:singleroutedepots} and~\eqref{const:singleroutecustomers} state that every depot and every customer is served by at most one route $r\in\rd$ and $r\in\rc$ in every period, respectively. 
Constraint~\eqref{const:serveopendepots} ensure that the routes used in period $t$ only pass through open depots, while constraint~\eqref{const:startfromopendepots} ensures that routes start only from opened depots. 
Constraints~\eqref{const:fleetcapadepots} and~\eqref{const:fleetcapaclients} states that the number of routes used to serve clients and depots in period $t$ does not exceed the fleet size allocated to the corresponding routes, respectively.
Constraints~\eqref{const:deliveryUBdepots} and~\eqref{const:deliveryUBcustomers} ensures that the sum of the quantities deliverd through a given route in a given period is lower than the capacity of a vehicle. 
Constraints~\eqref{const:invflowdepots} and~\eqref{const:invflowcustomers} define the units flow through the depots and customers, respectively.
Finally, constraints~\eqref{const:invdepotUB} and~\eqref{const:invcustUB} ensure that the capacity constraint on the inventory at the depots and the customers are satisfied in any period. 

\subsection{Restrictions}
Although the MIP formulation from~\S~\ref{subsection:MIP} deals with a rather general version of the problem, we focus on two particular cases:
\begin{enumerate}
    \item The first one considers a model ``Direct+Loop'' in which the set $\rd$ consists only of direct routes between the supplier and the depots. 
        That is, a route $r\in\rd$ can be described by two arcs $(s,j)$ and $(j,s)$, where $j\in\dc$ and $s$ is the supplier.
    \item The second one, called ``Loop+Direct'' considers a set $\rc$ containing only direct routes between depots and customers. 
        In other words, a route $r\in\rc$ can be described by two arcs $(j,i)$ and $(i,j)$ with $j\in\dc$ and $i\in\cu$. Figure~\ref{fig:ld}.
\end{enumerate}
Figure~\ref{fig:dl} and~\ref{fig:ld} illustrates the two types of structures related to these models.
\begin{figure}
    \centering
    \subcaptionbox[.45\linewidth]{Model ``Direct-Loop''\label{fig:dl}}{\inputfig{model1}}
    \subcaptionbox[.45\linewidth]{Model ``Loop-Direct''\label{fig:ld}}{\inputfig{model2}}
    \caption{The two types of routing structures considered}
\end{figure}


%-----------------------------------------------
\section{Matheuristic method} 
\label{sec:algo}

The matheuristic method we propose for the LIRP is based on a sampling of the routes. 
After being shuffled, the original set of routes is splitted into $\alpha$ independent subsets. 
Each subset is solved with Cplex, leading to $\alpha$ suboptimal LIRP solutions.  
The routes contained in each suboptimal solution are stored in a pool of \textit{promising routes}. 
Finally, the pool of promising routes is used to create a new (hopefully tractable) instance which solved with Cplex. 
Algorithm \ref{mainalgo} describes the procedure.


\begin{algorithm}
	\caption{The proposed sampling matheuristic}
	\label{mainalgo}
	%\scriptsize
	\begin{algorithmic}[1]
		\REQUIRE  The set $R$ of all routes generated
		\REQUIRE A parameter $\alpha$ (number of subsets)
		\REQUIRE $t1$ and $t2$: CPU allocated to Cplex in the inner and outer loop of the algorithm respectively
		\REQUIRE $J$ : parameter
		\STATE $z^*= +\infty$
		\STATE $collectedRoutes \leftarrow \emptyset$
		\REPEAT
			\STATE $amelioration = FALSE$
			\STATE $R =  R \backslash collectedRoutes$
			\STATE Shuffle all routes in $R$
			\STATE $LocationSampling(R,\alpha)$ \COMMENT{partitions $R$ into at most $\alpha$ subset of routes, regrouped by starting depots}
			\STATE $RouteSampling(R,\alpha)$	\COMMENT{partition $R$ into $\alpha$ independent subsets of routes}
			\FOR{$s=1$ to $\alpha$}
				\STATE $R_s = $ routes in subset $s$
				\STATE $bestRoutes_s = \emptyset$
				\FOR {$j=1$ to $J$}
					\STATE $R_s \leftarrow R_s \backslash bestRoutes_s$ \COMMENT{remove the route just found, active when $J>1$}
					\STATE $(z,bestRoutes_s) = SolveLIRP(R_s,t1)$ 
					\STATE $collectedRoutes \leftarrow bestRoutes_s$
				\ENDFOR
			\ENDFOR
			\STATE 	$(z,bestRoutes) = solveLIRP(collectedRoute, t2)$
			\IF {$z < z^*$}
				\STATE $z^*=z$
				\STATE $amelioration =TRUE$
			\ENDIF
		\UNTIL {$amelioration = FALSE$}
		\RETURN $bestRoutes$
	\end{algorithmic}
\end{algorithm}


\subsection{Location based sampling}

Location Sampling s'effectue en deux temps. 
Tout d'abord, les clients sont pré-affectés à un certain nombre de dépôts, comme décrit dans l'algo \ref{algo:pre-allocation}.
Ensuite, cette pré-affectation est utilisée pour constituer des sous-ensembles de routes, comme décrit dans l'algo 	\ref{algo:location-sampling}


\begin{algorithm}
	\caption{Pre-allocations of clients to depots}
	\label{algo:pre-allocation}
	%\scriptsize
	\begin{algorithmic}[1]
		\REQUIRE  $D$: set of depots
		\REQUIRE $C$: set of clients
		\REQUIRE $N_{close}, \mu_1, \mu_2, \mu_3$: parameters 
		\STATE
		\STATE Initialization: $A$: $|C| \times |D|$ allocation matrix filled with zeros
		\STATE Initialization: $dist$: $|C|\times|D|+|C|$ distance matrix between clients and other clients + depot
		\STATE
		\FOR {all clients $c \in C$}
			\FOR {all depots $d \in D$}
				\STATE calculate the distance $dist(c,d)$ between $c$ and $d$
			\ENDFOR
		\ENDFOR
		\STATE
		\FOR {all clients $c \in C$}
			\STATE $ClosestDepots(c) = $ List of all depots $d \in D$ ranked in non-decreasing order of the distances $dist(c,d)$.
			\STATE 	$A(c,ClosestDepots(c)[1]) =1$ 	\COMMENT{pre-allocate client $c$ to its closest depot}
			\FOR {$n=2$ to $N_{close}$}
				\IF {$dist(c,ClosestDepots(c)[n]) < \mu_1$}
					\STATE 	$A(c,ClosestDepots(c)[n]) =1$ 	\COMMENT{pre-allocate client $c$ to depot ranked $n$}
				\ENDIF
			\ENDFOR
		\ENDFOR
		\STATE
		\FOR {all clients $c \in C$ }
			\STATE Rank all clients $c' \in C$, $c' \neq c$ in non-decreasing order of the distances $dist(c,c')$ 
			\FOR {all clients $c'$}
				\IF {$dist(c,c') < \mu_2$} 
					\FOR {all $d \in ClosestDepots(c')$ such that $A(c',d)=1$}
						\IF {$A(c,d)=0$ and $dist(d,c')+dist(c',c)+dist(c,d) < \mu_3$}
							\STATE $A(c,d) =1$
						\ENDIF
					\ENDFOR
				\ENDIF
			\ENDFOR
		\ENDFOR
		\RETURN $A$
	\end{algorithmic}
\end{algorithm}




%------------------------------------------------------------

\begin{algorithm}
	\caption{Heuristic selection of depots}
	\label{algo:location-sampling}
	%\scriptsize
	\begin{algorithmic}[1]
		\REQUIRE $D$: set of depots
		\REQUIRE $C$: set of clients
		\REQUIRE $PreA$: pre-allocation matrix
		\REQUIRE $p$: number of depots to be selected
		\REQUIRE $\beta$: parameter strictly greater than 1.
		\STATE Initialize: $A$ allocation matrix to zero
		\STATE $s\leftarrow 0$: number of depots selected
		\STATE $nbClient \leftarrow 0$ number of clients assigned to a depot
		\STATE $S \leftarrow \emptyset$: list of selected depots
		\WHILE {$s < p$ and $nbClient < |C|$ } 
			\FOR {each depot $d \in D$}
				\STATE $score(d) =$ number of clients pre-allocated to $d$
			\ENDFOR
			\STATE Rank all depots by non-increasing scores
			\STATE Choose a random number $y$ from the interval $[0,1)$]
			\STATE $ S = S \cup \{D[\;\lceil y^\beta |D| \rceil]\; \}$.
			\STATE $s \leftarrow s +1$
			\FOR {all clients $c \in C$}
				\IF {$PreA[c][d] =1$}
					\STATE $A[c][d] = 1$
					\STATE $nbClient \leftarrow nbClient +1$
					\FOR {all depots $d \in D$}
						\STATE $PreA[c][d] = 0$
					\ENDFOR
				\ENDIF		
			\ENDFOR
		\ENDWHILE
		\IF {$nbClient < |C|$}
			\STATE Add a dummy depot $\delta$
			\FOR {all $c\in C$ such that $\sum\limits_{d \in D} PreA[c][d] >0$}
				\STATE $A[c][\delta]=1$
			\ENDFOR
		\ENDIF
		\RETURN $S$
		\RETURN $A$
	\end{algorithmic}
\end{algorithm}



\newpage
\subsection{Filtering SD routes after depot selection}

\begin{algorithm}
	\caption{SD Routes filtering}
	\label{algo:filteringSD}
	%\scriptsize
	\begin{algorithmic}[1]
		\REQUIRE $SDloop$: set of SD routes
		\REQUIRE $D$ set of depots
		\REQUIRE $C$: set of clients
		\REQUIRE $A$: allocation matrix
		
		\STATE $filteredSD \leftarrow \emptyset$
		
		\FOR {all $d\in D$}
			\FOR {all $c \in C$}
				\IF {$A[c][d]=1$}
					\STATE $filteredSD = filteredSD \cup \{s,d\}$
					\STATE $c = nbclient$
				\ENDIF
			\ENDFOR
		\ENDFOR
		\RETURN $filteredSD$
	\end{algorithmic}
\end{algorithm}


\subsection{Filtering DC routes after depot selection}

\begin{algorithm}
	\caption{DC Routes filtering}
	\label{algo:filteringDC}
	%\scriptsize
	\begin{algorithmic}[1]
		\REQUIRE $DCloop$: set of DC routes
		\REQUIRE $A$: allocation matrix
		\REQUIRE $C$: set of clients
		\REQUIRE $D$ set of depots
		
		\STATE $filteredDC \leftarrow \emptyset$
				
		\FOR {each route $r \in DCloop$}
			\STATE $keep = 1$
			\FOR {all $c \in r$}	
				\IF{$A[c][depot(r)]=0$}
					\STATE $keep=0$
					\STATE $c \leftarrow $ end of the route
				\ENDIF
			\ENDFOR  
			\IF {$keep=1$} 
				\STATE $filteredDC =filteredDC \cup \{r \}$
			\ENDIF
		\ENDFOR
		\RETURN $filtered DC$
	\end{algorithmic}
\end{algorithm}



%\begin{algorithm}
%	\caption{Generation of location oriented subsets (old version)}
%	\label{algo:location-sampling2}
%	%\scriptsize
%	\begin{algorithmic}[1]
%		\REQUIRE  $D$: set of depots
%		\REQUIRE $\alpha$: number of subsets to be generated
%		\REQUIRE $A$: pre-allocation matrix
%		\REQUIRE $\alpha$: number of subsets
%		\IF {$\alpha \ge |D|$ } 
%		\STATE $ListOfSubsets = \emptyset$
%		\STATE
%		\FOR {depot index $d=1$ to $|D|$} 
%			\STATE $ListOfSubsets = ListOfSubsets \cup \{d\}$
%		\ENDFOR
%		\STATE $NbSubsets \leftarrow |D| $		
%		\STATE
%		\STATE $n \leftarrow 2$
%		\WHILE{$NbSubsets < \alpha$}
%			\STATE $S_n$ = set of all sets of $n$ depots, ranked in non-increasing order of the number of common pre-allocated clients.
%			\REPEAT 
%				\STATE $s =$ first element of $S_n$
%				\STATE $ListOfSubsets = ListOfSubsets \cup \{s\}$
%				\STATE Remove $s$ from $S_n$
%				\STATE $NbSubsets \leftarrow NbSubsets+1$
%			\UNTIL ($S_n = \emptyset$ or $NbSubsets = \alpha$)
%		\STATE 	$n \leftarrow n+1$
%		\ENDWHILE
%		\ENDIF
%		\STATE 
%		\IF {$\alpha <  |D|$}
%			\FOR {all pairs $(i,j)$ of depots} 
%			\STATE Compute the similarity measure $M(i,j)$ equal to the number of clients pre-allocated both to $i$ and $j$.
%			\ENDFOR
%			\STATE Run $|D| - \alpha - 1$ iterations of Kruskal's algorithm with weights $\max\limits_{i,j} M(i,j) - M(i,j)$
%			\STATE $ListOfSubsets$ = one subset for each subtree yielded by Kruskal's algorithm 
%		\ENDIF
%		\RETURN $ListOfSubsets$
%	\end{algorithmic}
%\end{algorithm}


%--------------------------
\section{Numerical experiments}
\label{sec:expe}


\end{linenumbers}




\newpage
\section*{References}

\bibliographystyle{abbrvnat}
\bibliographystyle{plain}
\bibliography{biblio_LIRP}

\end{document}
